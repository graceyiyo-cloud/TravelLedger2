<!-- 版本：外幣顯示完美修復版 (Foreign Currency UI/UX Perfect Fix) - 複製清單外幣優先顯示 - 手機輸入框修復版 -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊費用分算紀錄</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
            background-color: #f9f7f2;
            color: #4a4a4a;
            -webkit-font-smoothing: antialiased;
            letter-spacing: 0.03em;
            font-weight: 700 !important;
        }

        *, *::before, *::after {
            font-weight: 700 !important;
            font-style: normal !important;
        }

        input, select, button {
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif !important;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #5c6b53 !important;
            box-shadow: 0 0 0 4px rgba(92, 107, 83, 0.08);
        }

        ::placeholder {
            font-weight: 700;
            opacity: 0.5;
        }

        ::-webkit-scrollbar {
            width: 5px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #e5e1d8;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const Icon = ({ name, className = "w-5 h-5" }) => {
            return <i data-lucide={name} className={className}></i>;
        };

        const APP_ID = 'travel-expense-splitter-v1';
        const CURRENCIES = [
            { code: 'TWD', name: '台幣', symbol: 'TWD' },
            { code: 'USD', name: '美金', symbol: 'USD' },
            { code: 'JPY', name: '日圓', symbol: '¥' },
            { code: 'KRW', name: '韓元', symbol: '₩' },
            { code: 'CNY', name: '人民幣', symbol: 'CNY' },
            { code: 'EUR', name: '歐元', symbol: 'EUR' },
            { code: 'HKD', name: '港幣', symbol: 'HKD' },
            { code: 'GBP', name: '英鎊', symbol: 'GBP' },
            { code: 'AUD', name: '澳幣', symbol: 'AUD' },
            { code: 'SGD', name: '新加坡幣', symbol: 'SGD' },
            { code: 'THB', name: '泰銖', symbol: 'THB' },
        ];

        function App() {
            const [members, setMembers] = useState([]);
            const [newMemberName, setNewMemberName] = useState('');
            const [expenses, setExpenses] = useState([]);
            const [rates, setRates] = useState({ TWD: 1 });
            const [loadingRates, setLoadingRates] = useState(false);
            const [showClearConfirm, setShowClearConfirm] = useState(false);
            const [toast, setToast] = useState(null);
            const [form, setForm] = useState({ item: '', amount: '', currency: 'TWD', payer: '', participants: [] });

            useEffect(() => {
                const savedData = localStorage.getItem(APP_ID);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    setMembers(parsed.members || []);
                    setExpenses(parsed.expenses || []);
                }
                fetchRates();
            }, []);

            useEffect(() => {
                localStorage.setItem(APP_ID, JSON.stringify({ members, expenses }));
                if (window.lucide) window.lucide.createIcons();
            }, [members, expenses, rates]);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            const fetchRates = async () => {
                setLoadingRates(true);
                try {
                    const res = await fetch(`https://open.er-api.com/v6/latest/TWD`);
                    const data = await res.json();
                    if (data && data.rates) {
                        const newRates = { TWD: 1 };
                        CURRENCIES.forEach(curr => {
                            if (curr.code === 'TWD') return;
                            if (data.rates[curr.code]) {
                                newRates[curr.code] = (1 / data.rates[curr.code] * 1.02).toFixed(4);
                            }
                        });
                        setRates(newRates);
                    }
                } catch (error) {
                    console.error("匯率更新失敗", error);
                } finally {
                    setLoadingRates(false);
                }
            };

            const addMember = () => {
                const trimmed = newMemberName.trim();
                if (!trimmed || members.includes(trimmed)) return;
                setMembers([...members, trimmed]);
                setNewMemberName('');
            };

            const removeMember = (name) => {
                setMembers(members.filter(m => m !== name));
                if (form.payer === name) setForm({ ...form, payer: '' });
                setForm(prev => ({ ...prev, participants: prev.participants.filter(p => p !== name) }));
            };

            const toggleParticipant = (name) => {
                setForm(prev => {
                    const isIncluded = prev.participants.includes(name);
                    return { ...prev, participants: isIncluded ? prev.participants.filter(p => p !== name) : [...prev.participants, name] };
                });
            };

            const formatNum = (num) => new Intl.NumberFormat('en-US').format(Math.round(num));

            const submitExpense = () => {
                const { item, amount, currency, payer, participants } = form;
                if (!item || !amount || !payer || participants.length === 0) return;
                const totalAmount = parseFloat(amount);
                const count = participants.length;
                const baseSplit = Math.round(totalAmount / count);
                const lastSplit = totalAmount - (baseSplit * (count - 1));
                const splits = {};
                participants.forEach((name, index) => { splits[name] = index === count - 1 ? lastSplit : baseSplit; });

                const newExpense = {
                    id: Date.now(),
                    item, amount: totalAmount, currency, rate: parseFloat(rates[currency] || 1),
                    payer, splits,
                    timestamp: new Date().toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                };
                setExpenses([...expenses, newExpense]);
                setForm({ ...form, item: '', amount: '', participants: [] });
                showToast("支出已記錄");
            };

            // 修正結算邏輯：全部轉 TWD 計算，並偵測主要外幣
            const settlement = useMemo(() => {
                const balances = {}; // 紀錄每個人的 TWD 餘額 (正=應收, 負=應付)
                let totalTWD = 0;
                members.forEach(m => balances[m] = 0);

                // 統計出現最多次的外幣
                const currencyCounts = {};
                expenses.forEach(e => {
                    if (e.currency !== 'TWD') {
                        currencyCounts[e.currency] = (currencyCounts[e.currency] || 0) + 1;
                    }
                });
                const primaryCode = Object.keys(currencyCounts).reduce((a, b) => currencyCounts[a] > currencyCounts[b] ? a : b, null);
                // 取得該外幣的參考匯率 (使用最新匯率表中的匯率，若無則用1)
                const primaryRate = primaryCode ? (rates[primaryCode] || 1) : 1;

                expenses.forEach(exp => {
                    const amountTWD = exp.amount * exp.rate;
                    totalTWD += amountTWD;
                    
                    // 付款人 + TWD金額
                    balances[exp.payer] = (balances[exp.payer] || 0) + amountTWD;
                    
                    // 分攤人 - TWD金額
                    Object.entries(exp.splits).forEach(([name, splitAmt]) => { 
                        // splitAmt 是外幣，需轉 TWD
                        balances[name] = (balances[name] || 0) - (splitAmt * exp.rate); 
                    });
                });

                const debtors = [], creditors = [];
                // 設定 1 TWD 的容錯區間避免浮點數誤差
                Object.entries(balances).forEach(([name, bal]) => {
                    if (bal < -1) debtors.push({ name, amount: Math.abs(bal) });
                    else if (bal > 1) creditors.push({ name, amount: bal });
                });

                const transactions = [];
                let dIdx = 0, cIdx = 0;
                // 深拷貝以免修改到原始陣列
                const td = JSON.parse(JSON.stringify(debtors)), tc = JSON.parse(JSON.stringify(creditors));
                
                while (dIdx < td.length && cIdx < tc.length) {
                    const amt = Math.min(td[dIdx].amount, tc[cIdx].amount);
                    if (amt > 0) transactions.push({ from: td[dIdx].name, to: tc[cIdx].name, amount: amt });
                    
                    td[dIdx].amount -= amt; 
                    tc[cIdx].amount -= amt;
                    
                    if (td[dIdx].amount <= 0.1) dIdx++;
                    if (tc[cIdx].amount <= 0.1) cIdx++;
                }

                return { totalTWD, transactions, primaryCode, primaryRate };
            }, [expenses, members, rates]);

            const copyToClipboard = () => {
                let text = `【費用結算清單】\n`;
                
                // 新增：代墊明細總覽
                let hasPrepaid = false;
                members.forEach(m => {
                    // 找出該成員代墊的所有項目
                    const paidItems = expenses.filter(e => e.payer === m);
                    if (paidItems.length > 0) {
                        hasPrepaid = true;
                        text += `\n${m} 預付：`;
                        
                        // 組合項目字串：項目1 $100 + 項目2 $200
                        const itemsStr = paidItems.map(e => {
                            const sym = CURRENCIES.find(c => c.code === e.currency).symbol;
                            return `${e.item} ${sym}${formatNum(e.amount)}`;
                        }).join(' + ');
                        
                        // 計算該成員總預付金額 (換算回台幣以方便加總)
                        const totalPrepaidTWD = paidItems.reduce((sum, e) => sum + (e.amount * e.rate), 0);
                        
                        text += `${itemsStr} = 總共預付 `;

                        if (settlement.primaryCode && settlement.primaryCode !== 'TWD') {
                            const approxForeign = totalPrepaidTWD / settlement.primaryRate;
                            const sym = CURRENCIES.find(c => c.code === settlement.primaryCode).symbol;
                            text += `約 ${sym} ${formatNum(approxForeign)} (TWD ${formatNum(totalPrepaidTWD)})`;
                        } else {
                            text += `TWD ${formatNum(totalPrepaidTWD)}`;
                        }
                    }
                });
                
                if (hasPrepaid) text += `\n`; // 如果有內容，多加一個換行讓版面好看

                text += `━━━━━━━━━━━━━━━\n\n`;

                members.forEach(member => {
                    const involved = expenses.filter(e => e.splits[member] !== undefined);
                    if (involved.length > 0) {
                        text += `［${member}］\n`;
                        involved.forEach(e => {
                            const splitAmt = e.splits[member];
                            const twd = Math.round(splitAmt * e.rate);
                            const sym = CURRENCIES.find(c => c.code === e.currency).symbol;
                            text += ` - ${e.item}：${sym} ${formatNum(splitAmt)}${e.currency === 'TWD' ? '' : ` (TWD ${formatNum(twd)})`}\n`;
                        });
                        text += `\n`;
                    }
                });
                text += `━━━━━━━━━━━━━━━\n【最終收付】(建議以台幣結算)\n`;
                if (settlement.transactions.length === 0) text += `目前的帳目已結清。\n`;
                else {
                    settlement.transactions.forEach(t => {
                        // t.amount 已經是 TWD
                        text += `◆ ${t.from} → ${t.to}：`;
                        if (settlement.primaryCode && settlement.primaryCode !== 'TWD') {
                            const foreignAmt = Math.round(t.amount / settlement.primaryRate);
                            const sym = CURRENCIES.find(c => c.code === settlement.primaryCode).symbol;
                            text += `約 ${sym} ${formatNum(foreignAmt)} (TWD ${formatNum(t.amount)})`;
                        } else {
                            text += `TWD ${formatNum(t.amount)}`;
                        }
                        text += `\n`;
                    });
                }
                const el = document.createElement('textarea');
                el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                showToast("已複製詳細清單至剪貼簿");
            };

            return (
                <div className="min-h-screen pb-20 font-bold">
                    {/* Header */}
                    <header className="bg-white/90 backdrop-blur-md border-b border-[#e5e1d8] p-6 sticky top-0 z-40 flex justify-between items-center shadow-sm">
                        <div>
                            <h1 className="text-2xl flex items-center gap-2 text-[#5c6b53] font-bold">
                                <Icon name="map" className="w-6 h-6" /> 旅遊費用分算紀錄
                            </h1>
                            <p className="text-[10px] text-[#a8a297] mt-1 tracking-[0.3em] uppercase">Travel Ledger Pro</p>
                        </div>
                        <button onClick={fetchRates} className={`p-2 rounded-full text-[#a8a297] hover:text-[#5c6b53] transition-colors ${loadingRates ? 'animate-spin' : ''}`}>
                            <Icon name="refresh-cw" className="w-5 h-5" />
                        </button>
                    </header>

                    <main className="max-w-xl mx-auto p-4 space-y-10">
                        {/* 使用提示 (新增) */}
                        <div className="bg-[#fdfaf5] border border-[#e5e1d8] p-5 rounded-2xl shadow-sm flex items-start gap-4">
                            <div className="bg-[#5c6b53]/10 p-2 rounded-full text-[#5c6b53] mt-0.5 shrink-0">
                                <Icon name="info" className="w-5 h-5" />
                            </div>
                            <p className="text-sm text-[#7a746a] leading-relaxed">
                                用手機或是電腦開此網頁，紀錄會暫存紀錄在你使用的工具裡，網頁關起來重新打開已記錄的資料不會消失，下方支出明細旁邊有一顆全部清除按鈕，可供清除此次全部資料。
                            </p>
                        </div>

                        {/* 1. 同行夥伴 */}
                        <section className="bg-white rounded-2xl border border-[#e5e1d8] p-4 sm:p-6 shadow-sm flex flex-col">
                            <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-[#8d775f]">
                                <Icon name="users" /> 同行夥伴
                            </h2>
                            <div className="flex gap-2 mb-6">
                                <input type="text" value={newMemberName} onChange={e => setNewMemberName(e.target.value)} onKeyPress={e => e.key === 'Enter' && addMember()} placeholder="輸入夥伴姓名..." className="flex-1 min-w-0 px-4 py-3 bg-[#fdfaf5] border border-[#e5e1d8] rounded-xl outline-none text-base" />
                                <button onClick={addMember} className="bg-[#5c6b53] text-white px-5 rounded-xl shadow-md active:scale-95 transition-transform"><Icon name="user-plus" /></button>
                            </div>
                            <div className="flex flex-wrap gap-2.5">
                                {members.length === 0 ? (
                                    <p className="text-sm text-[#a8a297] italic opacity-70">點擊上方按鈕添加旅伴...</p>
                                ) : members.map(m => (
                                    <span key={m} className="bg-[#f3f0e9] text-[#5c6b53] px-4 py-2.5 rounded-lg flex items-center gap-3 text-sm font-black shadow-sm border border-[#e5e1d8]/50">
                                        {m} <button onClick={() => removeMember(m)} className="text-[#a8a297] hover:text-red-500"><Icon name="x" className="w-4 h-4" /></button>
                                    </span>
                                ))}
                            </div>
                        </section>

                        {/* 2. 紀錄支出 */}
                        <section className="bg-white rounded-2xl border border-[#e5e1d8] p-6 shadow-sm space-y-6">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-[#8d775f]"><Icon name="coffee" /> 紀錄一筆支出</h2>
                            
                            <div className="space-y-4">
                                <input type="text" value={form.item} onChange={e => setForm({...form, item: e.target.value})} placeholder="例如：晚餐、交通費、門票..." className="w-full px-4 py-3 bg-[#fdfaf5] border border-[#e5e1d8] rounded-xl outline-none text-base" />
                                
                                <div className="flex gap-3">
                                    <select value={form.currency} onChange={e => setForm({...form, currency: e.target.value})} className="w-[40%] px-3 py-2 bg-[#fdfaf5] border border-[#e5e1d8] rounded-xl text-base outline-none appearance-none">
                                        {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.name}</option>)}
                                    </select>
                                    <div className="relative flex-1">
                                        <span className="absolute left-4 top-3 text-[#a8a297] text-base leading-6">{CURRENCIES.find(c => c.code === form.currency).symbol}</span>
                                        <input type="text" value={form.amount} onChange={e => /^\d*\.?\d*$/.test(e.target.value) && setForm({...form, amount: e.target.value})} placeholder="0" className="w-full pl-14 pr-4 py-3 bg-[#fdfaf5] border border-[#e5e1d8] rounded-xl text-xl font-black outline-none text-right" />
                                    </div>
                                </div>

                                <div className="bg-[#fdfaf5] p-4 rounded-xl border border-[#e5e1d8]/60 space-y-2">
                                    <div className="flex justify-between items-center text-sm text-[#a8a297]">
                                        <span>即時匯率基準</span>
                                        <span className="font-mono text-xs">1 {form.currency} ≈ {rates[form.currency] || '1.0000'} TWD</span>
                                    </div>
                                    {form.amount && form.currency !== 'TWD' && (
                                        <div className="flex justify-between items-center text-base pt-2 border-t border-[#e5e1d8]/40">
                                            <span className="text-[#5c6b53] font-black uppercase text-xs">台幣估算</span>
                                            <span className="font-black text-[#5c6b53]">TWD {formatNum(parseFloat(form.amount) * (rates[form.currency] || 1))}</span>
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="space-y-3">
                                <label className="text-sm text-[#a8a297] font-black uppercase tracking-[0.2em] px-1">由誰預付</label>
                                <div className="flex flex-wrap gap-2.5">
                                    {members.map(m => <button key={m} onClick={() => setForm({...form, payer: m})} className={`px-4 py-2.5 rounded-xl border text-sm font-black transition-all ${form.payer === m ? 'bg-[#5c6b53] border-[#5c6b53] text-white shadow-md scale-105' : 'bg-white border-[#e5e1d8] text-[#7a746a]'}`}>{m}</button>)}
                                </div>
                            </div>

                            <div className="space-y-3">
                                <label className="text-sm text-[#a8a297] font-black uppercase tracking-[0.2em] px-1">誰要分攤</label>
                                <div className="flex flex-wrap gap-2.5">
                                    {members.map(m => <button key={m} onClick={() => toggleParticipant(m)} className={`px-4 py-2.5 rounded-xl border text-sm font-black transition-all ${form.participants.includes(m) ? 'bg-[#f3f0e9] border-[#5c6b53] text-[#5c6b53] shadow-sm' : 'bg-white border-[#e5e1d8] text-[#7a746a]'}`}>{m}</button>)}
                                    <button onClick={() => setForm({...form, participants: [...members]})} className="text-sm text-[#5c6b53] font-black border-b-2 border-[#5c6b53]/30 px-2 transition-all hover:border-[#5c6b53]">全部選取</button>
                                </div>
                            </div>

                            <button onClick={submitExpense} disabled={!form.item || !form.amount || !form.payer || form.participants.length === 0} className="w-full bg-[#5c6b53] text-white py-4 rounded-2xl text-lg shadow-lg tracking-[0.4em] font-black disabled:opacity-30 active:scale-[0.98] transition-all">記錄這筆支出</button>
                        </section>

                        {/* 累計看板 (更新：顯示外幣與台幣) */}
                        <section className="bg-[#5c6b53] rounded-3xl p-8 border border-[#e5e1d8] flex flex-col justify-center items-center text-center gap-2 relative shadow-xl text-white">
                            <h3 className="text-xs text-white/60 font-black tracking-[0.3em] uppercase mb-2">Total Trip Expenditure</h3>
                            
                            {/* 主要金額 (若有外幣優先顯示外幣，否則顯示台幣) */}
                            <div className="text-5xl font-black flex items-center justify-center gap-3">
                                <span className="text-base opacity-50 tracking-normal">
                                    {settlement.primaryCode && settlement.primaryCode !== 'TWD' 
                                        ? CURRENCIES.find(c => c.code === settlement.primaryCode)?.symbol 
                                        : 'TWD'}
                                </span> 
                                {formatNum(settlement.primaryCode && settlement.primaryCode !== 'TWD' 
                                    ? settlement.totalTWD / settlement.primaryRate 
                                    : settlement.totalTWD)}
                            </div>
                            
                            {/* 次要金額 (若上方顯示外幣，下方顯示台幣參考) */}
                            {settlement.primaryCode && settlement.primaryCode !== 'TWD' && (
                                <div className="text-white/80 text-lg font-bold bg-white/10 px-4 py-1.5 rounded-xl mt-2 border border-white/20">
                                    ≈ TWD {formatNum(settlement.totalTWD)}
                                </div>
                            )}

                            <div className="bg-white/20 border border-white/30 px-6 py-2 rounded-full flex items-center gap-3 text-sm font-black mt-4">
                                <Icon name="list" className="w-4 h-4" /> 共 {expenses.length} 筆明細
                            </div>
                        </section>

                        {/* 3. 支出明細 (更新：手機版 UI 強制換行顯示外幣與台幣) */}
                        <section className="space-y-6">
                            <div className="flex justify-between items-center px-2">
                                <h2 className="text-lg font-bold flex items-center gap-2 text-[#5c6b53]"><Icon name="scroll-text" /> 支出明細</h2>
                                <button onClick={() => setShowClearConfirm(true)} className="flex items-center gap-1.5 text-xs font-black text-[#a8a297] hover:text-red-500 transition-colors">
                                    <Icon name="trash-2" className="w-4 h-4" /> 全部清除
                                </button>
                            </div>
                            <div className="bg-white rounded-3xl border border-[#e5e1d8] p-6 space-y-12 shadow-sm min-h-[120px]">
                                {expenses.length === 0 ? (
                                    <div className="py-12 text-center text-[#a8a297] opacity-60">目前尚無紀錄</div>
                                ) : expenses.map((exp, idx) => {
                                    // 修正：直接使用 expenses.map 依照原始順序 (最早的在最上面)
                                    return (
                                        <div key={exp.id} className="relative pl-8 border-l-4 border-[#5c6b53]/20 pb-4">
                                            <div className="absolute left-[-10px] top-1.5 bg-[#5c6b53] rounded-full w-4 h-4 border-4 border-white shadow-sm" />
                                            <div className="flex justify-between items-start gap-4">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 flex-wrap">
                                                        <span className="text-xl font-black text-[#4a4a4a]">{idx + 1}. {exp.item}</span>
                                                        <span className="text-[10px] text-[#a8a297] tracking-widest bg-[#fdfaf5] px-2 py-0.5 rounded border border-[#e5e1d8]">{exp.timestamp}</span>
                                                    </div>
                                                    {/* 支出者區塊 - 手機版優化 */}
                                                    <div className="text-base text-[#7a746a] mt-3 font-bold leading-relaxed">
                                                        <div className="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-2">
                                                            <span><span className="text-[#5c6b53] font-black">{exp.payer}</span> 預付了</span>
                                                            <div className="flex items-baseline gap-2">
                                                                <span className="text-[#5c6b53] text-lg sm:text-xl font-black">{CURRENCIES.find(c => c.code === exp.currency).symbol} {formatNum(exp.amount)}</span>
                                                                {exp.currency !== 'TWD' && (
                                                                    <span className="text-xs text-[#5c6b53]/80 font-bold bg-[#5c6b53]/10 px-2 py-0.5 rounded-md whitespace-nowrap">
                                                                        ≈ TWD {formatNum(exp.amount * exp.rate)}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button onClick={() => setExpenses(expenses.filter(e => e.id !== exp.id))} className="text-[#e5e1d8] hover:text-red-500 transition-colors p-1"><Icon name="trash" className="w-5 h-5" /></button>
                                            </div>
                                            
                                            {/* 分攤區塊 - 手機版優化：外幣與台幣明確換行 */}
                                            <div className="grid grid-cols-2 sm:grid-cols-2 gap-3 sm:gap-4 mt-6">
                                                {Object.entries(exp.splits).map(([name, amt]) => (
                                                    <div key={name} className="bg-[#fdfaf5] p-3 sm:p-4 rounded-2xl border border-[#e5e1d8]/60 text-sm shadow-sm hover:border-[#5c6b53]/30 transition-colors flex flex-col justify-between">
                                                        <div className="text-[#a8a297] font-black text-xs uppercase mb-1 tracking-tighter">［{name}］分攤</div>
                                                        <div>
                                                            <div className="text-[#5c6b53] font-black text-base sm:text-lg leading-tight">
                                                                {CURRENCIES.find(c => c.code === exp.currency).symbol} {formatNum(amt)}
                                                            </div>
                                                            {exp.currency !== 'TWD' && (
                                                                <div className="text-[11px] text-[#8d775f] font-black mt-1.5 opacity-90 pt-1.5 border-t border-[#e5e1d8]/60 block">
                                                                    ≈ TWD {formatNum(amt * exp.rate)}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* 4. 結算統計 (更新：同時顯示 TWD 與 主要外幣) */}
                        <section className="space-y-6">
                            <div className="flex justify-between items-center px-2">
                                <h2 className="text-lg font-bold flex items-center gap-2 text-[#5c6b53]"><Icon name="check-circle-2" /> 最終結算結餘</h2>
                                <button onClick={copyToClipboard} className="flex items-center gap-2 text-xs font-black text-white bg-[#5c6b53] px-5 py-3 rounded-full hover:bg-[#4a5843] shadow-lg active:scale-95 transition-all"><Icon name="copy" className="w-4 h-4" /> 複製結算清單</button>
                            </div>
                            <div className="bg-white rounded-[2rem] border border-[#e5e1d8] overflow-hidden shadow-md">
                                <div className="bg-[#fdfaf5] p-6 border-b border-[#e5e1d8] flex justify-between items-center">
                                    <h4 className="text-lg text-[#5c6b53] font-black tracking-[0.2em]">Final Settlement</h4>
                                    <span className="text-[10px] text-[#a8a297] font-black opacity-60 tracking-widest">{new Date().toLocaleDateString()}</span>
                                </div>
                                <div className="p-4 sm:p-6 space-y-6">
                                    {settlement.transactions.map((t, i) => (
                                        <div key={i} className="flex flex-col sm:flex-row items-center justify-between p-4 sm:p-6 bg-[#fdfaf5] rounded-[2rem] border border-[#e5e1d8]/50 gap-4 sm:gap-6">
                                            {/* Transaction Flow: From -> To */}
                                            <div className="flex flex-col sm:flex-row items-center gap-2 sm:gap-5 w-full sm:w-auto">
                                                <div className="flex flex-col items-center w-full sm:w-auto">
                                                    <span className="text-xs text-[#a8a297] uppercase mb-1 sm:mb-2 font-black tracking-widest">應付者</span>
                                                    <div className="text-base font-black text-[#4a4a4a] bg-white px-4 py-2 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl border border-[#e5e1d8] w-full sm:min-w-[100px] text-center shadow-sm break-all">{t.from}</div>
                                                </div>
                                                
                                                <Icon name="arrow-right" className="text-[#5c6b53] mt-2 sm:mt-6 animate-pulse rotate-90 sm:rotate-0" />
                                                
                                                <div className="flex flex-col items-center w-full sm:w-auto">
                                                    <span className="text-xs text-[#a8a297] uppercase mb-1 sm:mb-2 font-black tracking-widest">應收者</span>
                                                    <div className="text-base font-black text-[#4a4a4a] bg-white px-4 py-2 sm:px-5 sm:py-3 rounded-xl sm:rounded-2xl border border-[#e5e1d8] w-full sm:min-w-[100px] text-center shadow-sm break-all">{t.to}</div>
                                                </div>
                                            </div>

                                            {/* Amount Display (Updated: Show Foreign primary, TWD secondary) */}
                                            <div className="text-center sm:text-right w-full sm:w-auto border-t sm:border-t-0 border-[#e5e1d8]/50 pt-3 sm:pt-0 mt-2 sm:mt-0 flex flex-col justify-center sm:items-end">
                                                <div className="text-2xl font-black text-[#5c6b53] whitespace-nowrap">
                                                    <span className="text-sm font-bold opacity-60 mr-1">
                                                         {settlement.primaryCode && settlement.primaryCode !== 'TWD' 
                                                            ? CURRENCIES.find(c => c.code === settlement.primaryCode)?.symbol 
                                                            : 'TWD'}
                                                    </span> 
                                                    {formatNum(settlement.primaryCode && settlement.primaryCode !== 'TWD' 
                                                        ? t.amount / settlement.primaryRate 
                                                        : t.amount)}
                                                </div>
                                                {settlement.primaryCode && settlement.primaryCode !== 'TWD' && (
                                                    <div className="text-sm text-[#8d775f] font-black mt-1 opacity-80 bg-[#e5e1d8]/40 px-3 py-1 rounded-lg inline-block sm:block">
                                                        ≈ TWD {formatNum(t.amount)}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {settlement.transactions.length === 0 && (
                                        <div className="text-center py-16 text-[#a8a297] font-black border-4 border-dashed border-[#f3f0e9] rounded-[2.5rem]">所有帳目均已結清</div>
                                    )}
                                </div>
                                <div className="bg-[#fdfaf5] py-5 text-center text-[10px] text-[#a8a297] tracking-[0.3em] font-black opacity-60 uppercase border-t border-[#e5e1d8]/40">Happy Travel • Fair Sharing</div>
                            </div>
                        </section>
                    </main>

                    {/* Toast 訊息 */}
                    {toast && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-[#4a4a4a] text-white px-8 py-4 rounded-2xl shadow-2xl z-[150] font-black text-sm tracking-widest animate-bounce">
                            {toast}
                        </div>
                    )}

                    {/* 清除確認 */}
                    {showClearConfirm && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[100] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[3rem] p-12 max-w-sm w-full shadow-2xl border border-[#e5e1d8] text-center scale-up-center">
                                <h3 className="text-2xl font-black text-red-500 mb-6">全部清除？</h3>
                                <p className="text-[#7a746a] text-base mb-12 leading-relaxed font-black">確定要移除所有旅伴與支出明細嗎？此操作無法還原。</p>
                                <div className="flex flex-col gap-4">
                                    <button onClick={() => { setExpenses([]); setMembers([]); setShowClearConfirm(false); showToast("紀錄已全數清除"); }} className="w-full py-5 bg-red-500 text-white text-base font-black rounded-2xl tracking-[0.4em] uppercase shadow-lg active:scale-95 transition-all">確認移除</button>
                                    <button onClick={() => setShowClearConfirm(false)} className="w-full py-4 text-[#a8a297] text-sm font-black uppercase hover:text-[#4a4a4a]">取消</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>